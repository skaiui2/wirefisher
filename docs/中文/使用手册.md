# wirefisher
wirefisher：一个基于eBPF技术的网络观察及流量控制工具。

支持网卡、ip及端口、进程、进程组级别的流量观察，统计对应的流速及记录数据包信息，也支持对应的流量限速功能，可根据需求自定义针对进程或者端口进行限流。

后期会开发网络优化功能，如流量重定向、负载均衡器、零拷贝等。

## 环境要求

- Linux 内核版本 ≥ 5.4，需支持 eBPF 和 CO-RE
- 需要 root 权限运行
- 安装 libbpf 和 clang 工具链

具体环境搭建可参考同目录下的 **eBPF环境搭建.md** 文件。

## 使用方式

Wirefisher 的使用非常简单，只需编写YAML 配置文件，指定你要控制的对象和速率即可：

## 功能特点

- 按进程限速（PID）
- 按 IP、端口、协议过滤与限速
- 按网卡进行速率控制
- 按 cgroup 统一调度
- 支持 ingress / egress 双向控制
- 实时速率统计：平均速率、峰值速率、平滑速率

## 配置文件示例

进入配置目录：

```bash
cd config
vim config.yaml
```

可以这样配置：

```
process_module:
  process_rule:
    target_pid: 4580
    rate_bps: 1M
    gress: ingress
    time_scale: 1s
```



## 编译与运行

编译 BPF 程序：

```bash
cd bpf
make
cd ..
```

构建用户态控制程序：

```bash
mkdir build
cd build
cmake ..
make
```

启动 wirefisher：

```bash
sudo ./wirefisher
```

程序将根据 `config.yaml` 中的配置自动加载限速规则并开始运行。



## 模块配置说明

Wirefisher 支持多种限速策略模块，通过 YAML 文件进行配置。每个模块可独立启用，字段含义如下：

## 通用字段

- `rate_bps`: 限速速率（支持单位：K/M/G）
- `gress`: 流量方向（`ingress` 或 `egress`）
- `time_scale`: 时间窗口（如 `1s`, `500ms`），即保证在每个该时间段内流量整体不会超过限速。例如：rate_bps为1M，time_scale设置为1s，就是配置为：每个1s内，流速都不会超过1M/s。如果设置为60s，则是确保每个60s内，流速不会超过1M/s.

## 模块说明

### 分布式监控需求

可以配置kafka，把采集到的信息发送到其他平台，当然，如果没有这个需求，这里不用管。

```c
kafka:
  brokers: "localhost:9092"
  topic: "wirefisher.flow"
```

### cgroup_module

```yaml
cgroup_module:
  cgroup_rule:
    target_cgroup: "/sys/fs/cgroup"
    rate_bps: 100M
    gress: ingress
    time_scale: 1s
```

- 对指定 cgroup 路径下的所有进程限速
- 适用于容器或服务组

### eth_module

```yaml
eth_module:
  eth_rule:
    target_if: ens33
    rate_bps: 1M
    gress: ingress
    time_scale: 1s
```

- 对指定网卡限速
- 适用于虚拟网卡或边缘设备

### process_module

```yaml
process_module:
  process_rule:
    target_pid: 4580
    rate_bps: 1M
    gress: ingress
    time_scale: 1s
```

- 对指定进程限速
- 适用于调试或隔离单个进程

### ip_pro_port_module

```yaml

ip_pro_port_module:
  ip_pro_port_rule:
    only_watch: enable
    src_ip:   0 
    src_port: 9090
    dst_ip: fe80::20c:29ff:fea8:3f54    
    dst_port: 0                
    protocol: TCP                        
    rate_bps:   1M 
    time_scale: 1s                          
    gress: ingress                          
    src_ip_enable:     disable
    src_port_enable:   disable
    dst_ip_enable:     enable
    dst_port_enable:   disable
    protocol_enable:   enable
```

- 对 IP、端口、协议组合限速。还可以只监控，此时监控的是整个网络的流量，也就是每个包的网络五元组，但是不会显示流速信息。
- 可单独启用任意匹配项

## 启用方式

- 默认所有模块关闭，取消注释即可启用
- 可组合启用多个模块，策略将自动合并



## 切换拥塞控制算法

可以针对某个连接的一端切换本地的拥塞控制算法：

例如：当检测到远程ip和远程端口符合时，本地对这个端点的连接的拥塞控制算法切换为bbr。

如果想检测本地的ip和本地端口，remote写false即可。

```yaml
tcp_switch_module:
  tcp_switch_rule:
    ip: 192.168.200.5
    port: 0
    remote: true
    congestion: bbr
```

